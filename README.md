# StackPatch
**Hot-Patching Framework for Embedded Systems**  
StackPatch reconstructs stack frames to apply live security patches on embedded devices without rebooting.

## Table of Contents
1. [Repository Structure](#repository-structure)
2. [Demo Projects](#demo-projects) 
3. [Hardware and Software Requirements](#hardware-and-software-requirements)  
4. [Usage Guide](#usage-guide)
   - [Recommended: STM32F401RE / nRF52840](#recommended-stm32f401re--nrf52840)  
   - [GD32VF103](#gd32vf103)  
   - [ESP32S3](#esp32s3) 
5. [License](#license) 

---

## Repository Structure

StackPatch/  
├── Evaluation/  
│   ├── Compare/  
│   ├── DispatchDelayBinarySearch/  
│   ├── HeartRateSensor/  
│   └── NetworkServiceLatency/  
├── VulDevice/  
│   ├── ESP32S3/  
│   ├── GD32VF103/  
│   └── STM32F401RE/  
└── README.md  



- **Evaluation/**: performance comparisons and scenario benchmarks.  
- **VulDevice/**: platform‑specific StackPatch runtime and patch examples.  

---

## Demo Projects
This repository contains 11 demos illustrating patch development and application:

- **VulDevice/ESP32S3**  
  StackPatch on the Xtensa‑LX7 (ESP32S3) platform.  
- **VulDevice/GD32VF103**  
  StackPatch on the RISC‑V32 (GD32VF103) platform.  
- **VulDevice/STM32F401RE/flashpatch/dwtflashpatch**  
  DWT hardware‑breakpoint patch mode.  
- **VulDevice/STM32F401RE/flashpatch/fpbflashpatch**  
  FPB hardware‑breakpoint patch mode.  
- **VulDevice/STM32F401RE/srampatch/bootloader**  
  Bootloader for executing patched code in SRAM.  
- **VulDevice/STM32F401RE/srampatch/freertos_cve_test**  
  Software‑breakpoint patch for FreeRTOS vulnerabilities.  
- **VulDevice/STM32F401RE/srampatch/sram_cve**  
  Software‑breakpoint patch for other RTOS vulnerabilities.  
- **Evaluation/Compare**  
  Performance comparison with other hot‑patching frameworks.  
- **Evaluation/DispatchDelayBinarySearch**  
  Patch dispatcher performance using binary search.  
- **Evaluation/HeartRateSensor**  
  Patching a heart‑rate sensor vulnerability.  
- **Evaluation/NetworkServiceLatency**  
  Patching network service vulnerabilities and measuring latency.

> **Demo Directory Layout** (example):
> ```
> Drivers/      # HAL driver libraries  
> Middlewares/  # RTOS source code  
> Projects/     # Keil/Eclipse project files  
> Output/       # Compiled binaries  
> User/         # Application code  
> ```  
> - `startup_stm32f401xe.s`: modified `DebugMon_Handler` and `HardFault_Handler`.  
> - `cve.c`: vulnerable function from our paper.  
> - `patch.c`: hot‑patch code generated by StackPatch.  

---

## Hardware and Software Requirements
To reproduce the results in our paper, you need one of these boards:  
**nRF52840**, **STM32F401RE**, **GD32VF103**, or **ESP32S3**.  
**Recommended**: STM32F401RE with Keil µVision5.

**Common Requirements**:
- Windows 10  
- Serial terminal tool (e.g., pyserial)  
- Debugger: J‑LINK, ST‑LINK, or GD‑LINK  

---

## Usage Guide

### Recommended: STM32F401RE
1. Install and launch Keil µVision5.  
2. Connect the board to your PC via debugger (e.g., ST‑LINK).  
3. Open the Keil project in  
4. Build and flash the firmware.  
5. Use a serial terminal to view StackPatch log output.

### GD32VF103
- IDE: Eclipse  
- Debugger: GD‑Link  

Replace the component’s `entry.S` (modified `trap_entry` handler) to integrate StackPatch.

### ESP32S3
- Toolchain: ESP‑IDF (Python, Git, cross‑compilers, CMake, Ninja)  
- Debugger: J‑LINK  

1. Replace `panic_handler_asm.S` in ESP‑IDF (modified `xt_panic` handler).  
2. Run `instrument.py` to instrument target functions.  
3. Build and flash via ESP‑IDF.  
4. Monitor serial output for StackPatch logs.

---

## License
This project is licensed under the MIT License.  