# StackPatch
**Hot-Patching Framework for Embedded Systems**
StackPatch reconstructs stack frames to apply live security patches on embedded devices without rebooting.

## Table of Contents
1. [Repository Structure](#repository-structure)
2. [Demo Projects](#demo-projects) 
3. [Hardware and Software Requirements](#hardware-and-software-requirements)  
4. [Usage Guide](#usage-guide)
   - [Recommended: STM32F401RE / nRF52840](#recommended-stm32f401re--nrf52840)  
   - [GD32VF103](#gd32vf103)  
   - [ESP32S3](#esp32s3) 
5. [License](#license) 

---

## Repository Structure

StackPatch/
├── Evaluation/
│   ├── Compare/
│   ├── DispatchDelayBinarySearch/
│   ├── HeartRateSensor/
│   └── NetworkServiceLatency/
├── VulDevice/
│   ├── ESP32S3/
│   ├── GD32VF103/
│   └── STM32F401RE/
└── README.md



- **Evaluation/**: performance comparisons and scenario benchmarks.  
- **VulDevice/**: platform‑specific StackPatch runtime and patch examples.  

---

## Demo Projects
This repository contains 11 demos illustrating patch development and application:

- **VulDevice/ESP32S3**  
  StackPatch on the Xtensa‑LX7 (ESP32S3) platform.  
- **VulDevice/GD32VF103**  
  StackPatch on the RISC‑V32 (GD32VF103) platform.  
- **VulDevice/STM32F401RE/flashpatch/dwtflashpatch**  
  DWT hardware‑breakpoint patch mode.  
- **VulDevice/STM32F401RE/flashpatch/fpbflashpatch**  
  FPB hardware‑breakpoint patch mode.  
- **VulDevice/STM32F401RE/srampatch/bootloader**  
  Bootloader for executing patched code in SRAM.  
- **VulDevice/STM32F401RE/srampatch/freertos_cve_test**  
  Software‑breakpoint patch for FreeRTOS vulnerabilities.  
- **VulDevice/STM32F401RE/srampatch/sram_cve**  
  Software‑breakpoint patch for other RTOS vulnerabilities.  
- **Evaluation/Compare**  
  Performance comparison with other hot‑patching frameworks.  
- **Evaluation/DispatchDelayBinarySearch**  
  Patch dispatcher performance using binary search.  
- **Evaluation/HeartRateSensor**  
  Patching a heart‑rate sensor vulnerability.  
- **Evaluation/NetworkServiceLatency**  
  Patching network service vulnerabilities and measuring latency.

> **Demo Directory Layout** (example):
> ```
> Drivers/      # HAL driver libraries  
> Middlewares/  # RTOS source code  
> Projects/     # Keil/Eclipse project files  
> Output/       # Compiled binaries  
> User/         # Application code  
> ```  
> - `startup_stm32f401xe.s`: modified `DebugMon_Handler` and `HardFault_Handler`.  
> - `cve.c`: vulnerable function from our paper.  
> - `patch.c`: hot‑patch code generated by StackPatch.  

---

## Hardware and Software Requirements
To reproduce the results in our paper, you need one of these boards:  
**nRF52840**, **STM32F401RE**, **GD32VF103**, or **ESP32S3**.  
**Recommended**: STM32F401RE with Keil µVision5.

**Common Requirements**:
- Windows 10  
- Serial terminal tool (e.g., pyserial)  
- Debugger: J‑LINK, ST‑LINK, or GD‑LINK  

---

## Usage Guide

### Recommended: STM32F401RE / nRF52840
1. Install and launch Keil µVision5.  
2. Connect the board to your PC via debugger (e.g., ST‑LINK).  
3. Open the Keil project in  
4. Build and flash the firmware.  
5. Use a serial terminal to view StackPatch log output.

### GD32VF103
- IDE: Eclipse  
- Debugger: GD‑Link  

Replace the component’s `entry.S` (modified `trap_entry` handler) to integrate StackPatch.

### ESP32S3
- Toolchain: ESP‑IDF (Python, Git, cross‑compilers, CMake, Ninja)  
- Debugger: J‑LINK  

1. Replace `panic_handler_asm.S` in ESP‑IDF (modified `xt_panic` handler).  
2. Run `instrument.py` to instrument target functions.  
3. Build and flash via ESP‑IDF.  
4. Monitor serial output for StackPatch logs.

---

## License
This project is licensed under the MIT License.  


<!-- 



```
-------------\
| - Evaluation: The evluation of StackPatch was conducted using STM32F401RE (Coetex-M4), GD32VF103 (RSIC-V32), and ESP32S3 (Xtensa-LX7) development boards.
└─── Compare: The comparison with other hot patching approaches for embedded systems.
└─── DispatchDelayBinarySearch: Added performance evaluation of the patch dispatcher for binary Search.
└─── HeartRateSensor: StackPatch fixes a vulnerability in the heart rate sensor.
└─── NetworkServiceLatency: StackPatch fixes the vulnerabilities Network Services.

| - VulDevice: This folder contains the implementation of StackPatch on the STM32F401RE (Coetex-M4), GD32VF103 (RSIC-V32), and ESP32S3 (Xtensa-LX7) development boards. 
└─── ESP32S3: Implementation of StackPatch on the STM32F401RE board.
└─── GD32VF103: Implementation of StackPatch on the STM32F401RE board.
└─── STM32F401RE: Implementation of StackPatch on the STM32F401RE board.
```

## This repository contains 11 demo projects, and you can use them to facilitate patch development:
 - StackPatch\VulDevice\ESP32S3 : Implementation of StackPatch on the STM32F401RE board.
 - StackPatch\VulDevice\GD32VF103 : Implementation of StackPatch on the STM32F401RE board.
 - StackPatch\VulDevice\STM32F401RE\flashpatch\dwtflashpatch : Implementation of stackpatch hardware breakpoint mode (DWT) on stm32f401re board.
 - StackPatch\VulDevice\STM32F401RE\flashpatch\fpbflashpatch : Implementation of stackpatch hardware breakpoint mode (FPB) on stm32f401re board.
 - StackPatch\VulDevice\STM32F401RE\srampatch\bootloader : Bootloader for executing programs in SRAM.
 - StackPatch\VulDevice\STM32F401RE\srampatch\freertos_cve_test : Using software breakpoints to fix vulnerabilities in FreeRTOS.
 - StackPatch\VulDevice\STM32F401RE\srampatch\sram_cve : Using software breakpoints to fix vulnerabilities in other RTOSes.
 - StackPatch\Evaluation\Compare : Performance comparison between stackpatch and other work.
 - StackPatch\Evaluation\dispatchdelayBinarySearch : Add the binary search function of stackpatch scheduling patch.
 - StackPatch\Evaluation\HeartTateSensor\fpbflashpatch: Experiment of stackpatch in repairing vulnerabilities in heart rate sensor.
 - StackPatch\Evaluation\NetworkSreverLatency : Experiment of repairing web server with stackpatch.

A demo folder introduction example : 
└─── Drivers: Drive configuration file (including the Hal Library).
└─── Middlewares: Including RTOS kernel source code.
└─── Output: By compiling the demo, the output file.
└─── Projects: Keil project of the demo.
└─── User: User's program.
We modify two exception handlers, DebugMon_Handler and HardFault_Handler, in the startup_stm32f401xe.s file. 
The cve.c file is a vulnerability function in our paper. 
The patch.c file is a hot patch for C programs generated by StackPatch. 

### Requirements 
To evaluate *StackPatch* and obtain results similar to those presented in the paper, access to one of the following **four** boards is required: 
**nRF52840, STM32-F401RE, GD32VF103 or ESP32S3**
We recommend using the STM32F401RE board to compile the StackPatch runtime with keil IDE. 


# STM32-F401RE (recommend) or nRF52840   
Required:
 - Windows 10.
 - Keil uVision5 IDE.
 - Serial port tool (such as pyserial).
 - a debugger (J-LINK or ST-LINK).


Usage:
   1. Use a debugger (such as ST-LINK) to connect the PC to the development board.
   2. Open the KEIL project in the VulDevice/STM32F401RE/ folder (such as VulDevice\STM32F401RE\flashpatch\fpbflashpatch\Projects\MDK-ARM\f401re.uvprojx)
   3. Compiler and download the firmware to the board. 
   4. Using the serial port tool to communicate with the board, you can see the repair log of StackPatch.


# GD32VF103  
Required:
 - Windows 10.
 - eclipse IDE.
 - Serial port tool (such as pyserial).
 - a debugger (GD-LINK).

Usage: 
 - entry.S: We have modified the entry.S in the component, specifically the trap_entry exception handling function. You can use it to replace the corresponding file.


# ESP32S3
Required:
 - Windows 10.
 - ESP-IDF (including Python, Git, cross-compilers, CMake, Ninja compilation tools, etc.).
 - Serial port tool (such as pyserial).
 - a debugger (J-LINK).

Usage:
 - panic_handler_asm.S: We have modified the panic_handler_asm.S in the ESP-IDF component (which integrates FreeRTOS), specifically the xt_panic exception handling function. You can use it to replace the corresponding file in ESP-IDF.
 - instrument.py: You can use it to perform instrumentation for functions in ESP-IDF. -->